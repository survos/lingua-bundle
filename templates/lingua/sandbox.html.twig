{% extends 'base.html.twig' %}

{% block body %}
    <div class="container my-4">
        <h1>Lingua Sandbox</h1>

        <form method="post" action="{{ path('lingua_sandbox') }}" class="mb-3">
            <div class="row g-3 mb-3">
                <div class="col-md-3">
                    <label class="form-label">Source</label>
                    <input class="form-control" name="source" value="{{ defaults.source }}">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Target(s)</label>
                    <input class="form-control" name="target" value="{{ defaults.target }}" placeholder="es or es,fr,pt">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Engine</label>
                    <input class="form-control" name="engine" value="{{ defaults.engine }}" placeholder="libre, deepl, ...">
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Texts (one per line)</label>
                <textarea class="form-control" name="texts" rows="6">{{ defaults.textsRaw }}</textarea>
            </div>

            <div class="row g-3 mb-3">
                <div class="col-md-3 form-check">
                    <input class="form-check-input" type="checkbox" id="insertNewStrings" name="insertNewStrings" value="1"
                           {% if defaults.insertNewStrings %}checked{% endif %}>
                    <label for="insertNewStrings" class="form-check-label">Insert new strings</label>
                </div>

                <div class="col-md-3 form-check">
                    <input class="form-check-input" type="checkbox" id="forceDispatch" name="forceDispatch" value="1"
                           {% if defaults.forceDispatch %}checked{% endif %}>
                    <label for="forceDispatch" class="form-check-label">Force dispatch</label>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Transport</label>
                    <input class="form-control" id="transport" name="transport" value="{{ defaults.transport ?? '' }}" placeholder="async (optional)">
                    <div class="form-text">Leave blank for default; set to "async" to queue.</div>
                </div>

                <div class="col-md-3 form-check">
                    <input class="form-check-input" type="checkbox" id="direct" name="direct" value="1"
                           {% if defaults.direct %}checked{% endif %}>
                    <label for="direct" class="form-check-label">Direct mode (no HTTP)</label>
                </div>
            </div>

            <button type="submit" class="btn btn-primary">Send</button>
        </form>

        {% if result is defined and result %}
            <h2 class="mt-4">Result</h2>

            {% if result.mode is defined %}
                <p><strong>Mode:</strong> {{ result.mode }}</p>
            {% endif %}

            {% if result.status is defined %}
                <p><strong>Status:</strong> {{ result.status }}</p>
            {% endif %}

            {# If server returns {status, response:{...}} show response fields #}
            {% set resp = result.response is defined and result.response ? result.response : result %}

            {% if resp.jobId is defined and resp.jobId %}
                <p><strong>Job ID:</strong> {{ resp.jobId }}</p>
            {% endif %}

            {% if resp.queued is defined %}
                <p><strong>Queued:</strong> {{ resp.queued }}</p>
            {% endif %}

            {% if resp.missing is defined and resp.missing %}
                <p><strong>Missing:</strong> {{ resp.missing|length }}</p>
            {% endif %}

            {% set items = resp.items is defined ? resp.items : [] %}
            {% if items %}
                <div class="table-responsive">
                    <table class="table table-sm table-striped align-middle">
                        <thead>
                        <tr>
                            <th>#</th>
                            <th>Hash</th>
                            <th>Text</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for i in items %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td><code>{{ i.hash ?? '' }}</code></td>
                                <td style="white-space: pre-wrap">{{ i.text ?? (i.targetText ?? '') }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endif %}

            <details class="mt-3">
                <summary>Raw JSON</summary>
                <pre>{{ result|json_encode(constant('JSON_PRETTY_PRINT')) }}</pre>
            </details>
        {% endif %}
    </div>
{% endblock %}
